<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Foto com Moldura</title>
<style>
body, html { margin:0; padding:0; height:100%; background:#000; font-family:Arial,sans-serif; overflow:hidden; }
#camera-container { position:relative; width:100vw; height:100vh; background:#000; }
video { position:absolute; width:100%; height:100%; object-fit:cover; }
#moldura { position:absolute; width:100%; height:100%; pointer-events:none; object-fit:contain; }
#botoes { position:fixed; bottom:30px; width:100%; display:flex; justify-content:center; gap:25px; z-index:10; }
button { padding:14px; font-size:28px; border:none; border-radius:50%; background:rgba(255,255,255,0.2); backdrop-filter:blur(6px); color:white; font-weight:bold; cursor:pointer; transition:0.2s; }
button:hover { background: rgba(255,255,255,0.35); }
#preview-container { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); display:none; justify-content:center; align-items:center; flex-direction:column; z-index:20; }
#preview-container img { max-width:90%; max-height:80%; border:4px solid white; border-radius:16px; margin-bottom:20px; }
#preview-buttons { display:flex; gap:30px; }
#preview-buttons button { border-radius:14px; padding:12px 20px; font-size:20px; }
</style>
</head>
<body>

<div id="camera-container">
    <video id="camera" autoplay playsinline></video>
    <img id="moldura" src="moldura.png">
</div>

<div id="botoes">
    <button id="flash">‚ö°‚ùå</button>
    <button id="trocar">üîÑ</button>
    <button id="foto">üì∑</button>
</div>

<div id="preview-container">
    <img id="preview-img" src="">
    <div id="preview-buttons">
        <button id="tirar-nova">Tirar outra</button>
        <button id="salvar-preview">Salvar</button>
    </div>
</div>

<canvas id="canvas" width="1080" height="1920" style="display:none;"></canvas>

<script>
const video = document.getElementById("camera");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const moldura = document.getElementById("moldura");
const preview = document.getElementById("preview-container");
const previewImg = document.getElementById("preview-img");

let usandoFrontal = false;
let streamAtual = null;
let ultimaFoto = null;
let flashAtivo = false;
let track = null;

// Detecta iOS
const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;

// Inicializa c√¢mera
async function iniciarCamera() {
    if(streamAtual) streamAtual.getTracks().forEach(t=>t.stop());

    const constraints = { video: { facingMode: usandoFrontal ? "user" : "environment" }, audio:false };

    try {
        streamAtual = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = streamAtual;
        track = streamAtual.getVideoTracks()[0];
        video.style.transform = usandoFrontal ? "scaleX(-1)" : "scaleX(1)";
        flashAtivo = false;
        updateFlashIcon();
    } catch(err) {
        alert("Erro ao acessar a c√¢mera: "+err);
    }
}

// Atualiza √≠cone do flash
function updateFlashIcon() { document.getElementById("flash").textContent = flashAtivo ? "‚ö°" : "‚ö°‚ùå"; }

// Flash (Android suporta torch)
document.getElementById("flash").onclick = async ()=>{
    if(!track) return;
    const capabilities = track.getCapabilities();
    if(!capabilities.torch) { alert("Seu dispositivo n√£o suporta flash."); return; }
    flashAtivo = !flashAtivo;
    await track.applyConstraints({ advanced: [{ torch: flashAtivo }] });
    updateFlashIcon();
}

// Virar c√¢mera
document.getElementById("trocar").onclick = ()=>{ usandoFrontal=!usandoFrontal; iniciarCamera(); }

// Fun√ß√£o para preencher canvas 9:16 mantendo propor√ß√£o (cover)
function drawVideoCover(){
    const vw = video.videoWidth;
    const vh = video.videoHeight;
    const cw = canvas.width;
    const ch = canvas.height;

    const scale = Math.max(cw/vw, ch/vh);
    const drawWidth = vw*scale;
    const drawHeight = vh*scale;
    const drawX = (cw - drawWidth)/2;
    let drawY = (ch - drawHeight)/2;

    // Frontal: ajusta um pouco para mostrar rosto
    if(usandoFrontal) drawY -= drawHeight*0.05;

    return { drawX, drawY, drawWidth, drawHeight };
}

// Tirar foto
document.getElementById("foto").onclick = ()=>{
    if(!video.videoWidth) return;

    ctx.fillStyle="#000";
    ctx.fillRect(0,0,canvas.width,canvas.height);

    const { drawX, drawY, drawWidth, drawHeight } = drawVideoCover();

    if(usandoFrontal){
        ctx.save();
        ctx.scale(-1,1);
        ctx.drawImage(video,0,0,video.videoWidth,video.videoHeight,-canvas.width - drawX,drawY,drawWidth,drawHeight);
        ctx.restore();
    }else{
        ctx.drawImage(video,0,0,video.videoWidth,video.videoHeight,drawX,drawY,drawWidth,drawHeight);
    }

    ctx.drawImage(moldura,0,0,canvas.width,canvas.height);

    ultimaFoto = canvas.toDataURL("image/png");
    previewImg.src = ultimaFoto;
    preview.style.display = "flex";
}

// Tirar outra
document.getElementById("tirar-nova").onclick = ()=>preview.style.display="none";

// Salvar
document.getElementById("salvar-preview").onclick = ()=>{
    if(!ultimaFoto) return;
    const a=document.createElement("a");
    a.href=ultimaFoto;
    a.download="foto-com-moldura.png";
    a.click();
}

// Inicializa
iniciarCamera();
</script>

</body>
</html>
